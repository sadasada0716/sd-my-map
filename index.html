<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>東京消防庁マップ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body { margin:0; padding:0; }
  #map { height:90vh; width:100%; }

  /* ▼ モーダル表示用 */
  #photoModal {
    display: none;                /* 初期は非表示 */
    position: fixed;              /* 画面に固定 */
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.7);  /* 半透明の黒背景 */
    justify-content: center;      /* 中央寄せ */
    align-items: center;
    z-index: 99999;               /* 地図より前面 */
  }
  #photoModal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
    box-shadow: 0 0 20px #000;
  }

  /* 車両バッジの簡単な装飾（任意） */
  .vehicle-badge {
    display:inline-block;
    margin:2px;
    padding:2px 6px;
    background:#eee;
    border-radius:4px;
    cursor:pointer;
  }
</style>
</head>
<body>
<h1 style="text-align:center;margin:10px;">東京消防庁_1745</h1>
<div id="map"></div>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnksYoKQz5NyBwIQUrWeHC9UUgaWFnErJzuBQT36Lrp59gR4Q9fzvGI51EtcoxFJNcJNKE58tv_A_Q/pub?gid=0&single=true&output=csv";

const map = L.map('map').setView([35.68,139.76],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const icons = {
  red:    L.icon({ iconUrl:'icons/red.png',    iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32] }),
  blue:   L.icon({ iconUrl:'icons/blue.png',   iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32] }),
  green:  L.icon({ iconUrl:'icons/green.png',  iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32] }),
  orange: L.icon({ iconUrl:'icons/orange.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32] }),
  hqr:    L.icon({ iconUrl:'icons/hqr.png',    iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32] }),
  hpr:    L.icon({ iconUrl:'icons/hpr.png',    iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32] })
};

Papa.parse(sheetUrl, {
  download: true,
  header: true,
  complete: function(results) {
    results.data.forEach(row => {
      if (!row.lat || !row.lng) return;
      const iconChoice = icons[row.icon] || icons.red;

      const vehicles = [];
      for (let i = 1; i <= 20; i++) {
        const num = (row[`vehicle${i}`] || '').trim();
        if (!num) continue;
        const photo = (row[`vehicle${i}_photo`] || '').trim();

        vehicles.push(
          `<span class="vehicle-badge" data-photo="${photo}">${num}</span>`
        );
      }

      const vehicleList = vehicles.length ? vehicles.join(' ') : '<p>車両登録なし</p>';

      const popupHtml = `
        <div style="width:200px">
          <h3 style="margin:0;font-size:16px;">${row.name}</h3>
          <p style="margin:4px 0;">${row.address}<br><strong>配置車両</strong></p>
          <div class="vehicle-badge-box">${vehicleList}</div>
        </div>
      `;

      const marker = L.marker([+row.lat, +row.lng], { icon: iconChoice })
        .addTo(map)
        .bindPopup(popupHtml);

      // ポップアップが開いたときにクリックイベントを設定
      marker.on('popupopen', function() {
        document.querySelectorAll('.vehicle-badge').forEach(badge => {
          badge.addEventListener('click', function() {
            const p = this.dataset.photo;
            if (!p) return;
            document.getElementById('modalImg').src = 'photo/' + p;
            document.getElementById('photoModal').style.display = 'flex';
          });
        });
      });
    });
  }
});

// モーダルクリックで閉じる
document.getElementById('photoModal').addEventListener('click', function() {
  this.style.display = 'none';
});
</script>

<!-- ▼ モーダルは body の最後に置く -->
<div id="photoModal">
  <img id="modalImg" src="" alt="vehicle photo">
</div>

</body>
</html>
